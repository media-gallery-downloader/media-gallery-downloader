name: media-gallery-downloader

services:
    mgd_app:
        build:
            context: .
            dockerfile: .docker/Dockerfile
            target: ${DOCKER_TARGET:-production}
            args:
                UID: ${UID:-1000}
                GID: ${GID:-1000}
                TZ: ${TZ:-UTC}
        container_name: mgd_app
        restart: unless-stopped
        working_dir: /app
        environment:
            TZ: ${TZ:-UTC}
            APP_ENV: ${APP_ENV:-production}
            APP_DEBUG: ${APP_DEBUG:-false}
            LOG_CHANNEL: stack
            LOG_LEVEL: ${LOG_LEVEL:-warning}
        extra_hosts:
            - "host.docker.internal:host-gateway"
        ports:
            - "${HTTP_PORT:-8080}:8080"
        networks:
            - mgd_internal
            - mgd_external
        volumes:
            - ./storage/app/data:/app/storage/app/data:rw
            - ./database:/app/database:rw
            - ./bootstrap/cache:/app/bootstrap/cache:rw
            - .:/app:rw # Full project mount for development (comment out for production)
        tmpfs:
            - /tmp:noexec,nosuid,size=500m
            - /run:noexec,nosuid,size=10m
        stop_grace_period: 30s
        security_opt:
            - no-new-privileges:true
        cap_drop:
            - ALL
        cap_add:
            - NET_BIND_SERVICE
            - SETGID
            - SETUID
        logging:
            driver: json-file
            options:
                max-size: "10m"
                max-file: "3"
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8080/up"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s
        deploy:
            resources:
                limits:
                    memory: ${MEMORY_LIMIT:-4G}
                reservations:
                    memory: ${MEMORY_RESERVATION:-2G}
        depends_on:
            mgd_valkey:
                condition: service_healthy
    mgd_valkey:
        image: valkey/valkey:9-alpine
        container_name: mgd_valkey
        restart: unless-stopped
        command: valkey-server --save 60 1 --loglevel warning --maxmemory 256mb --maxmemory-policy allkeys-lru
        networks:
            - mgd_internal
        volumes:
            - mgd_valkey_data:/data
        security_opt:
            - no-new-privileges:true
        cap_drop:
            - ALL
        cap_add:
            - SETGID
            - SETUID
        read_only: true
        tmpfs:
            - /tmp:mode=1777
        logging:
            driver: json-file
            options:
                max-size: "5m"
                max-file: "2"
        healthcheck:
            test: ["CMD", "valkey-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 3
            start_period: 10s

networks:
    mgd_internal:
        driver: bridge
        internal: true
    mgd_external:
        driver: bridge

volumes:
    mgd_valkey_data:
        driver: local
